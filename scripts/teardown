#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/_common.sh"

load_env

echo ""
log_warn "This will remove Airflow and all associated data!"
echo ""
echo "The following will be deleted:"
echo "  - Helm release: airflow"
echo "  - Namespace: ${AIRFLOW_NAMESPACE}"
echo "  - Persistent volumes: airflow-dags-pv, airflow-logs-pv"
echo "  - Volumes directory: ${VOLUMES_PATH}"
echo ""
read -p "Are you sure? (y/N): " confirm

if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    log_info "Cancelled"
    exit 0
fi

# Uninstall Helm release
log_info "Uninstalling Airflow Helm release..."
helm uninstall airflow -n "${AIRFLOW_NAMESPACE}" 2>/dev/null || true

# Delete namespace (this will delete all resources in it)
log_info "Deleting namespace ${AIRFLOW_NAMESPACE}..."
kubectl delete namespace "${AIRFLOW_NAMESPACE}" --timeout=60s 2>/dev/null || true

# Delete persistent volumes
log_info "Deleting persistent volumes..."
kubectl delete pv airflow-dags-pv airflow-logs-pv 2>/dev/null || true

# Remove volumes directory
log_info "Removing volumes directory..."
sudo rm -rf "${VOLUMES_PATH}"

log_success "Teardown complete!"

echo ""
read -p "Also uninstall K3s? (y/N): " uninstall_k3s
if [[ "$uninstall_k3s" =~ ^[Yy]$ ]]; then
    log_info "Uninstalling K3s..."
    /usr/local/bin/k3s-uninstall.sh 2>/dev/null || true
    log_success "K3s uninstalled"
fi
